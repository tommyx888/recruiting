<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Navigation Alerts</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .candidate-item {
            padding: 5px;
            border-bottom: 1px solid #eee;
            margin: 2px 0;
        }
        .hired { background-color: #d4edda; }
        .rejected { background-color: #f8d7da; }
        .active { background-color: #fff3cd; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔔 Test Navigation Alerts</h1>
        <p>This page will test if navigation alerts are properly filtered for hired and rejected candidates.</p>
        
        <div class="test-section info">
            <h3>📋 Current User Info</h3>
            <div id="user-info" class="result"></div>
        </div>

        <div class="test-section">
            <h3>👥 Test Candidates by Status</h3>
            <button onclick="loadCandidatesByStatus()">Load Candidates by Status</button>
            <div id="candidates-by-status" class="result"></div>
        </div>

        <div class="test-section">
            <h3>🔔 Test Navigation Alerts</h3>
            <button onclick="testNavigationAlerts()">Test Navigation Alert Logic</button>
            <button onclick="testNameWarnings()">Test Name Warning Logic</button>
            <div id="alert-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>📊 Alert Statistics</h3>
            <button onclick="calculateAlertStats()">Calculate Alert Statistics</button>
            <div id="stats-result" class="result"></div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="utils.js"></script>
    <script src="auth.js"></script>
    <script src="candidates.js"></script>
    <script>
        // Initialize Supabase
        let supabase;
        
        async function initSupabase() {
            if (window.config && window.config.supabase) {
                const { createClient } = await import('https://cdn.skypack.dev/@supabase/supabase-js@2');
                supabase = createClient(window.config.supabase.url, window.config.supabase.anonKey);
                
                // Initialize managers
                if (window.AuthManager) {
                    window.authManager = new window.AuthManager();
                    window.authManager.init(supabase);
                }
                if (window.CandidatesManager) {
                    window.candidatesManager = new window.CandidatesManager();
                    window.candidatesManager.init(supabase);
                }
            }
        }

        async function showUserInfo() {
            const resultDiv = document.getElementById('user-info');
            try {
                const isAuthenticated = await window.authManager.checkAuth();
                const userInfo = window.authManager.getUserInfo();
                
                resultDiv.innerHTML = `Authenticated: ${isAuthenticated}
Role: ${userInfo.role || 'Not set'}
Department: ${userInfo.department || 'Not set'}`;
                
                if (userInfo.role === 'gm' || userInfo.role === 'recruiter') {
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                resultDiv.innerHTML = `❌ Error: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        async function loadCandidatesByStatus() {
            const resultDiv = document.getElementById('candidates-by-status');
            resultDiv.innerHTML = 'Loading candidates by status...';
            
            try {
                const candidates = await window.candidatesManager.getCandidates({ page: 1, pageSize: 100 });
                
                if (candidates.data.length === 0) {
                    resultDiv.innerHTML = 'No candidates found';
                    return;
                }

                // Group candidates by status
                const hired = candidates.data.filter(c => c.status && c.status.includes('Hired'));
                const rejected = candidates.data.filter(c => c.status && c.status.includes('Rejected'));
                const active = candidates.data.filter(c => !c.status || (!c.status.includes('Hired') && !c.status.includes('Rejected')));

                let html = `
                    <h4>📊 Candidates by Status:</h4>
                    <div style="margin: 10px 0;">
                        <strong>Hired Candidates (${hired.length}):</strong>
                        <div style="max-height: 100px; overflow-y: auto; border: 1px solid #ddd; padding: 5px;">
                `;
                
                hired.forEach(candidate => {
                    html += `<div class="candidate-item hired">${candidate.name} - ${candidate.status} (${candidate.last_updated ? new Date(candidate.last_updated).toLocaleDateString() : 'No date'})</div>`;
                });
                
                html += `
                        </div>
                    </div>
                    <div style="margin: 10px 0;">
                        <strong>Rejected Candidates (${rejected.length}):</strong>
                        <div style="max-height: 100px; overflow-y: auto; border: 1px solid #ddd; padding: 5px;">
                `;
                
                rejected.forEach(candidate => {
                    html += `<div class="candidate-item rejected">${candidate.name} - ${candidate.status} (${candidate.last_updated ? new Date(candidate.last_updated).toLocaleDateString() : 'No date'})</div>`;
                });
                
                html += `
                        </div>
                    </div>
                    <div style="margin: 10px 0;">
                        <strong>Active Candidates (${active.length}):</strong>
                        <div style="max-height: 100px; overflow-y: auto; border: 1px solid #ddd; padding: 5px;">
                `;
                
                active.forEach(candidate => {
                    html += `<div class="candidate-item active">${candidate.name} - ${candidate.status} (${candidate.last_updated ? new Date(candidate.last_updated).toLocaleDateString() : 'No date'})</div>`;
                });
                
                html += `
                        </div>
                    </div>
                `;
                
                resultDiv.innerHTML = html;
                resultDiv.className = 'result success';
            } catch (error) {
                resultDiv.innerHTML = `❌ Error: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        async function testNavigationAlerts() {
            const resultDiv = document.getElementById('alert-result');
            resultDiv.innerHTML = 'Testing navigation alert logic...';
            
            try {
                const candidates = await window.candidatesManager.getCandidates({ page: 1, pageSize: 1000 });
                const now = new Date();
                
                let orangeCount = 0; // More than 1 week
                let redCount = 0;    // More than 2 weeks
                let skippedHired = 0;
                let skippedRejected = 0;
                let processedActive = 0;
                
                candidates.data.forEach(candidate => {
                    // Skip alerts for hired and rejected candidates
                    if (candidate.status && (
                        candidate.status.includes('Hired') || 
                        candidate.status.includes('Rejected')
                    )) {
                        if (candidate.status.includes('Hired')) {
                            skippedHired++;
                        } else {
                            skippedRejected++;
                        }
                        return; // Skip this candidate
                    }
                    
                    processedActive++;
                    
                    if (candidate.last_updated) {
                        const lastUpdated = new Date(candidate.last_updated);
                        const diffTime = Math.abs(now - lastUpdated);
                        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                        
                        if (diffDays > 14) {
                            redCount++;
                        } else if (diffDays > 7) {
                            orangeCount++;
                        }
                    }
                });
                
                resultDiv.innerHTML = `✅ Navigation alert logic test completed:
                
📊 Results:
- Orange alerts (1+ week): ${orangeCount}
- Red alerts (2+ weeks): ${redCount}
- Processed active candidates: ${processedActive}
- Skipped hired candidates: ${skippedHired}
- Skipped rejected candidates: ${skippedRejected}

🔔 Alert indicators will show:
- Orange: ${orangeCount} candidates
- Red: ${redCount} candidates
- Total alerts: ${orangeCount + redCount}`;
                resultDiv.className = 'result success';
            } catch (error) {
                resultDiv.innerHTML = `❌ Error: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        async function testNameWarnings() {
            const resultDiv = document.getElementById('alert-result');
            resultDiv.innerHTML = 'Testing name warning logic...';
            
            try {
                const candidates = await window.candidatesManager.getCandidates({ page: 1, pageSize: 100 });
                const now = new Date();
                
                let results = {
                    total: candidates.data.length,
                    hired: [],
                    rejected: [],
                    active: [],
                    nameWarnings: 0,
                    skippedWarnings: 0
                };
                
                candidates.data.forEach(candidate => {
                    const nameWithWarning = createNameWithWarning(candidate);
                    const hasWarning = nameWithWarning.includes('🚨') || nameWithWarning.includes('⚠️');
                    
                    if (candidate.status && candidate.status.includes('Hired')) {
                        results.hired.push({
                            name: candidate.name,
                            status: candidate.status,
                            nameWithWarning: nameWithWarning,
                            hasWarning: hasWarning
                        });
                        if (!hasWarning) results.skippedWarnings++;
                    } else if (candidate.status && candidate.status.includes('Rejected')) {
                        results.rejected.push({
                            name: candidate.name,
                            status: candidate.status,
                            nameWithWarning: nameWithWarning,
                            hasWarning: hasWarning
                        });
                        if (!hasWarning) results.skippedWarnings++;
                    } else {
                        results.active.push({
                            name: candidate.name,
                            status: candidate.status,
                            nameWithWarning: nameWithWarning,
                            hasWarning: hasWarning
                        });
                        if (hasWarning) results.nameWarnings++;
                    }
                });
                
                let html = `✅ Name warning logic test completed:
                
📊 Results:
- Total candidates: ${results.total}
- Hired candidates: ${results.hired.length} (warnings skipped: ${results.hired.filter(h => !h.hasWarning).length})
- Rejected candidates: ${results.rejected.length} (warnings skipped: ${results.rejected.filter(r => !r.hasWarning).length})
- Active candidates: ${results.active.length} (warnings shown: ${results.active.filter(a => a.hasWarning).length})

🔍 Sample results:`;

                if (results.hired.length > 0) {
                    html += `\n\nHired candidates (should have NO warnings):`;
                    results.hired.slice(0, 3).forEach(candidate => {
                        html += `\n- ${candidate.name}: "${candidate.nameWithWarning}" (warning: ${candidate.hasWarning ? 'YES' : 'NO'})`;
                    });
                }

                if (results.rejected.length > 0) {
                    html += `\n\nRejected candidates (should have NO warnings):`;
                    results.rejected.slice(0, 3).forEach(candidate => {
                        html += `\n- ${candidate.name}: "${candidate.nameWithWarning}" (warning: ${candidate.hasWarning ? 'YES' : 'NO'})`;
                    });
                }

                if (results.active.length > 0) {
                    html += `\n\nActive candidates (may have warnings):`;
                    results.active.slice(0, 3).forEach(candidate => {
                        html += `\n- ${candidate.name}: "${candidate.nameWithWarning}" (warning: ${candidate.hasWarning ? 'YES' : 'NO'})`;
                    });
                }
                
                resultDiv.innerHTML = html;
                resultDiv.className = 'result success';
            } catch (error) {
                resultDiv.innerHTML = `❌ Error: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        // Helper function to simulate createNameWithWarning
        function createNameWithWarning(candidate) {
            const name = candidate.name || '';
            
            // Skip warnings for hired and rejected candidates
            if (candidate.status && (
                candidate.status.includes('Hired') || 
                candidate.status.includes('Rejected')
            )) {
                return name; // Return name without warnings
            }
            
            const now = new Date();
            const lastUpdated = new Date(candidate.last_updated);
            const diffTime = Math.abs(now - lastUpdated);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            let warningIcon = '';
            let warningClass = '';
            let tooltipText = '';
            
            if (diffDays > 14) {
                // More than 2 weeks - red warning
                warningIcon = '🚨';
                warningClass = 'name-warning-red';
                tooltipText = `Kritické! Kandidát bez zmeny ${diffDays} dní (viac ako 2 týždne)`;
            } else if (diffDays > 7) {
                // More than 1 week - orange warning
                warningIcon = '⚠️';
                warningClass = 'name-warning-orange';
                tooltipText = `Upozornenie! Kandidát bez zmeny ${diffDays} dní (viac ako týždeň)`;
            }
            
            if (warningIcon) {
                return `<span class="candidate-name ${warningClass}" title="${tooltipText}">${warningIcon} ${name}</span>`;
            }
            
            return name;
        }

        async function calculateAlertStats() {
            const resultDiv = document.getElementById('stats-result');
            resultDiv.innerHTML = 'Calculating alert statistics...';
            
            try {
                const candidates = await window.candidatesManager.getCandidates({ page: 1, pageSize: 1000 });
                const now = new Date();
                
                let stats = {
                    total: candidates.data.length,
                    hired: 0,
                    rejected: 0,
                    active: 0,
                    orangeAlerts: 0,
                    redAlerts: 0,
                    skipped: 0
                };
                
                candidates.data.forEach(candidate => {
                    if (candidate.status && candidate.status.includes('Hired')) {
                        stats.hired++;
                        stats.skipped++;
                        return;
                    }
                    
                    if (candidate.status && candidate.status.includes('Rejected')) {
                        stats.rejected++;
                        stats.skipped++;
                        return;
                    }
                    
                    stats.active++;
                    
                    if (candidate.last_updated) {
                        const lastUpdated = new Date(candidate.last_updated);
                        const diffTime = Math.abs(now - lastUpdated);
                        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                        
                        if (diffDays > 14) {
                            stats.redAlerts++;
                        } else if (diffDays > 7) {
                            stats.orangeAlerts++;
                        }
                    }
                });
                
                resultDiv.innerHTML = `📊 Alert Statistics:
                
Total candidates: ${stats.total}
├── Hired: ${stats.hired} (skipped from alerts)
├── Rejected: ${stats.rejected} (skipped from alerts)
└── Active: ${stats.active} (checked for alerts)

Alert counts:
├── Orange alerts (1+ week): ${stats.orangeAlerts}
├── Red alerts (2+ weeks): ${stats.redAlerts}
└── Total alerts: ${stats.orangeAlerts + stats.redAlerts}

Skipped from alerts: ${stats.skipped} (hired + rejected)`;
                resultDiv.className = 'result success';
            } catch (error) {
                resultDiv.innerHTML = `❌ Error: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            await initSupabase();
            await showUserInfo();
            console.log('Navigation alerts test page initialized');
        });
    </script>
</body>
</html>
